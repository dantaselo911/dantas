(function() {
  'use strict';

  // ====== COLE AQUI SEU GABARITO (j√° limpo: s√≥ numero + texto/imagem) ======
  const gabarito = [
    { "questao_numero": 1, "alternativa_correta": "[IMAGEM] https://edusp-static.ip.tv/tms/edusp/tv.ip.edusp/AaiDkRlOyyjITYDe1ETaY9e6LrN130.jpg" },
    { "questao_numero": 2, "alternativa_correta": "1,09" },
    { "questao_numero": 3, "alternativa_correta": "igual a 8." },
    { "questao_numero": 4, "alternativa_correta": "resolu√ß√£o IV." },
    { "questao_numero": 5, "alternativa_correta": "[IMAGEM] https://edusp-static.ip.tv/tms/edusp/tv.ip.edusp/BbtopN2SvNHSSoKIV5KVuoYjDMYAqA.jpg" },
    { "questao_numero": 6, "alternativa_correta": "R$ 381,00" },
    { "questao_numero": 7, "alternativa_correta": "10" },
    { "questao_numero": 8, "alternativa_correta": "[IMAGEM] data:image/jpeg;base64,/9j/4AAQSk..." },
    { "questao_numero": 9, "alternativa_correta": "1,21" },
    { "questao_numero": 10, "alternativa_correta": "[IMAGEM] https://edusp-static.ip.tv/tms/edusp/tv.ip.edusp/OVxvxi5cmA5JcqLmGCiDXLRf6Ss9hW.jpg" },
    { "questao_numero": 11, "alternativa_correta": "10" },
    { "questao_numero": 12, "alternativa_correta": "[IMAGEM] https://edusp-static.ip.tv/tms/edusp/tv.ip.edusp/1EMDxRK2CPNi8Ho5Wk47TcVd4LGsvf.jpg" },
    { "questao_numero": 13, "alternativa_correta": "[IMAGEM] data:image/jpeg;base64,/9j/4AAQSk..." },
    { "questao_numero": 14, "alternativa_correta": "30" },
    { "questao_numero": 15, "alternativa_correta": "5 20" },
    { "questao_numero": 16, "alternativa_correta": "R$ 2.560,00" },
    { "questao_numero": 17, "alternativa_correta": "Saber quanto se ganha e quanto se pode gastar, evitando desequil√≠brios." },
    { "questao_numero": 18, "alternativa_correta": "Planejamento financeiro inadequado." },
    { "questao_numero": 19, "alternativa_correta": "Negociar as d√≠vidas e ajustar o or√ßamento familiar." },
    { "questao_numero": 20, "alternativa_correta": "Refletir se realmente precisa de algo a mais antes de decidir pela compra." },
    { "questao_numero": 21, "alternativa_correta": "Registro di√°rio e organizado de todos os gastos, inclusive os pequenos." },
    { "questao_numero": 22, "alternativa_correta": "Evitar d√≠vidas e fazer escolhas que respeitem a pr√≥pria realidade financeira." },
    { "questao_numero": 23, "alternativa_correta": "RNA." },
    { "questao_numero": 24, "alternativa_correta": "realizado no n√∫cleo, √© produzida uma fita de RNA a partir do DNA." },
    { "questao_numero": 25, "alternativa_correta": "Tradu√ß√£o, que ocorre nos ribossomos e monta cadeias de amino√°cidos." },
    { "questao_numero": 26, "alternativa_correta": "3 verdes : 1 amarela" },
    { "questao_numero": 27, "alternativa_correta": "Clone √© um ser ou c√©lula com o mesmo material gen√©tico do original, √∫til na produ√ß√£o de tecidos e no estudo de doen√ßas." },
    { "questao_numero": 28, "alternativa_correta": "Esse tipo de tratamento atua substituindo, inativando ou reparando genes que causam doen√ßas gen√©ticas. √â importante que a decis√£o da fam√≠lia seja baseada em informa√ß√µes acess√≠veis e compreens√≠veis." },
    { "questao_numero": 29, "alternativa_correta": "Fonte prim√°ria, fonte prim√°ria, fonte secund√°ria." },
    { "questao_numero": 30, "alternativa_correta": "900" },
    { "questao_numero": 31, "alternativa_correta": "Refra√ß√£o da luz." },
    { "questao_numero": 32, "alternativa_correta": "Refrator." },
    { "questao_numero": 33, "alternativa_correta": "60¬∞" },
    { "questao_numero": 34, "alternativa_correta": "espelho esf√©rico convexo." },
    { "questao_numero": 35, "alternativa_correta": "o √¢nodo perde el√©trons e o c√°todo ganha el√©trons." },
    { "questao_numero": 36, "alternativa_correta": "+1" },
    { "questao_numero": 37, "alternativa_correta": "ŒîE¬∞ = +3,17 V" },
    { "questao_numero": 38, "alternativa_correta": "Ni-Cd, por apresentar o maior n√∫mero de ciclos." },
    { "questao_numero": 39, "alternativa_correta": "negativo, chamado c√°todo." },
    { "questao_numero": 40, "alternativa_correta": "Galvanoplastia: uso de corrente el√©trica para depositar uma camada de cromo sobre outro metal." },
    { "questao_numero": 41, "alternativa_correta": "Garantir contraste adequado entre texto e fundo." },
    { "questao_numero": 42, "alternativa_correta": "Um procedimento que ajuda a prevenir a viola√ß√£o de direitos autorais por registrar a origem e a licen√ßa da imagem." },
    { "questao_numero": 43, "alternativa_correta": "Reescrever o conte√∫do do texto com suas pr√≥prias palavras e indicar a fonte da informa√ß√£o." },
    { "questao_numero": 44, "alternativa_correta": "Criar bot√µes de ajuste de tamanho de fonte." },
    { "questao_numero": 45, "alternativa_correta": "botaoDeAcessibilidade.addEventListener('click', function() { opcoesDeAcessibilidade.classList.toggle('apresenta-lista'); });" }
  ];

  // ====== UTIL ======
  function normalizar(txt) {
    if (txt == null) return '';
    try {
      return String(txt)
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/^[A-Z]\s*[)\.-]\s*/i, '') // tira A) B) etc do come√ßo
        .replace(/\s+/g, ' ')
        .trim();
    } catch (e) {
      return String(txt).toLowerCase().replace(/\s+/g, ' ').trim();
    }
  }

  function isVisible(el) {
    try {
      const rc = el.getBoundingClientRect();
      const style = getComputedStyle(el);
      return rc.width > 0 && rc.height > 0 && style.visibility !== 'hidden' && style.display !== 'none' && parseFloat(style.opacity || 1) > 0;
    } catch (e) {
      return false;
    }
  }

  // ====== CRIA PAINEL (DRAGGABLE) ======
  const container = document.createElement('div');
  container.id = 'autoResponderContainer_v1';
  Object.assign(container.style, {
    position: 'fixed',
    top: '18px',
    right: '18px',
    zIndex: 2147483647,
    fontFamily: 'Arial, sans-serif',
    width: '320px',
    boxShadow: '0 6px 24px rgba(0,0,0,0.4)',
    borderRadius: '10px',
    overflow: 'hidden'
  });

  container.innerHTML = `
    <div style="background:#2c3e50;color:#fff;padding:10px;display:flex;align-items:center;justify-content:space-between;cursor:grab;">
      <strong style="font-size:14px">ü§ñ AutoResponder</strong>
      <div style="display:flex;gap:8px">
        <button id="ar_minBtn" title="Minimizar" style="background:#34495e;border:none;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer">‚Äî</button>
        <button id="ar_closeBtn" title="Fechar" style="background:#e74c3c;border:none;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer">‚úï</button>
      </div>
    </div>
    <div style="background:#fff;color:#333;padding:12px" id="ar_body">
      <div id="ar_status" style="margin-bottom:10px;color:#333">Aguardando...</div>
      <button id="ar_start" style="width:100%;padding:8px;border-radius:6px;border:none;background:#27ae60;color:#fff;font-weight:700;cursor:pointer">‚ñ∂Ô∏è Iniciar Automa√ß√£o</button>
      <button id="ar_stop" style="width:100%;padding:8px;border-radius:6px;border:none;background:#e67e22;color:#fff;font-weight:700;cursor:pointer;display:none;margin-top:8px">‚èπÔ∏è Parar</button>
    </div>
  `;
  document.body.appendChild(container);

  // draggable
  (function makeDraggable(el) {
    const header = el.querySelector('div:first-child');
    let dragging = false, ox = 0, oy = 0;
    header.addEventListener('mousedown', e => {
      if (e.target.tagName === 'BUTTON') return; // n√£o arrasta quando clica nos bot√µes
      dragging = true;
      ox = e.clientX - el.getBoundingClientRect().left;
      oy = e.clientY - el.getBoundingClientRect().top;
      header.style.cursor = 'grabbing';
      e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      el.style.left = (e.clientX - ox) + 'px';
      el.style.top = (e.clientY - oy) + 'px';
      el.style.right = 'auto';
    });
    document.addEventListener('mouseup', () => {
      dragging = false;
      header.style.cursor = 'grab';
    });
  })(container);

  const statusEl = container.querySelector('#ar_status');
  const startBtn = container.querySelector('#ar_start');
  const stopBtn = container.querySelector('#ar_stop');
  const closeBtn = container.querySelector('#ar_closeBtn');
  const minBtn = container.querySelector('#ar_minBtn');
  const bodyEl = container.querySelector('#ar_body');

  closeBtn.addEventListener('click', ()=> { try { container.remove(); } catch(e){} });
  minBtn.addEventListener('click', ()=> {
    if (bodyEl.style.display === 'none') bodyEl.style.display = '';
    else bodyEl.style.display = 'none';
  });

  function setStatus(txt, color = '#333') {
    statusEl.textContent = txt;
    statusEl.style.color = color;
  }

  // ====== LOGICA PRINCIPAL ======
  let observing = false;
  let lastQuestionNumber = null;
  let observer = null;
  let checkInterval = null;
  let debounceTimer = null;

  function clicarElemento(el) {
    try {
      if (!el) return false;
      // prefer inputs
      const input = el.querySelector('input[type="radio"], input[type="checkbox"]');
      if (input && !input.disabled) {
        input.click();
        return true;
      }
      // anchors / buttons inside
      const bt = el.querySelector('button, a');
      if (bt) { bt.click(); return true; }
      // try clicking the element itself
      el.scrollIntoView({behavior:'smooth', block:'center'});
      el.dispatchEvent(new MouseEvent('mouseover', {bubbles:true}));
      el.click();
      return true;
    } catch (e) {
      try { el.click(); return true; } catch (e2) { return false; }
    }
  }

  function findOptionByImageUrl(elList, urlNormalized) {
    for (const el of elList) {
      try {
        const imgs = el.querySelectorAll ? el.querySelectorAll('img') : [];
        for (const img of imgs) {
          if (!img.src) continue;
          if (normalizar(img.src).includes(urlNormalized) || normalizar(img.getAttribute('data-src')||'').includes(urlNormalized)) {
            if (isVisible(el)) return el;
          }
        }
      } catch (e){}
    }
    return null;
  }

  function findOptionByText(elList, textNormalized) {
    for (const el of elList) {
      try {
        if (!el.textContent) continue;
        if (!isVisible(el)) continue;
        const nt = normalizar(el.textContent);
        if (nt.includes(textNormalized) || textNormalized.includes(nt)) {
          return el;
        }
      } catch (e){}
    }
    return null;
  }

  function gatherCandidates() {
    // seletor amplo mas n√£o brutal
    const selector = 'label, .option, .alternativa, .answer, li, div, p, span, button, td';
    return Array.from(document.querySelectorAll(selector));
  }

  function getQuestionNumberFromPage() {
    // Busca texto que contenha "quest√£o X" (case-insensitive)
    try {
      const all = Array.from(document.querySelectorAll('h1,h2,h3,h4,div,p,span,label,section'));
      for (const el of all) {
        if (!el.textContent) continue;
        const m = el.textContent.match(/quest[√£a]o[\s:\-]*?(\d{1,3})/i);
        if (m) return parseInt(m[1], 10);
      }
      // fallback: procurar "Quest√£o" em qualquer elemento
      const any = Array.from(document.querySelectorAll('*'));
      for (const el of any) {
        if (!el.textContent) continue;
        const m = el.textContent.match(/quest[√£a]o[\s:\-]*?(\d{1,3})/i);
        if (m) return parseInt(m[1], 10);
      }
      return null;
    } catch (e) { return null; }
  }

  function attemptAnswer() {
    try {
      const qnum = getQuestionNumberFromPage();
      if (!qnum) { setStatus('‚ùå N√£o identifiquei n√∫mero da quest√£o na p√°gina.'); return; }
      if (qnum === lastQuestionNumber) return;
      lastQuestionNumber = qnum;
      setStatus(`üîé Detectei quest√£o ${qnum} ‚Äî procurando no gabarito...`, '#1f618d');

      const qObj = gabarito.find(x => x.questao_numero === qnum);
      if (!qObj) { setStatus(`‚ö†Ô∏è Quest√£o ${qnum} n√£o est√° no gabarito.`, '#e67e22'); setTimeout(tryNext, 800); return; }

      const raw = qObj.alternativa_correta || '';
      const isImagem = /^\[IMAGEM\]\s*/i.test(raw);
      const textToMatch = isImagem ? normalizar(raw.replace(/^\[IMAGEM\]\s*/i, '')) : normalizar(raw);

      const candidates = gatherCandidates();

      let alvo = null;
      if (isImagem) {
        // tenta achar por <img src> que contenha a url/base64
        alvo = findOptionByImageUrl(candidates, textToMatch);
        if (!alvo) {
          // tamb√©m tenta por texto (algumas plataformas mostram a URL como texto)
          alvo = findOptionByText(candidates, textToMatch);
        }
      } else {
        alvo = findOptionByText(candidates, textToMatch);
      }

      if (!alvo) {
        setStatus(`‚ö†Ô∏è Alternativa n√£o encontrada na tela para Q${qnum}. (tentando pular)`, '#e67e22');
        setTimeout(tryNext, 700);
        return;
      }

      // se o alvo for um filho, sobe at√© o label ou container clic√°vel
      let clickable = alvo;
      let climb = 0;
      while (clickable && climb < 6 && !['LABEL','LI','BUTTON','A','DIV','P','SPAN','TD'].includes(clickable.tagName)) {
        clickable = clickable.parentElement;
        climb++;
      }
      if (!clickable) clickable = alvo;

      // tenta clicar
      const ok = clicarElemento(clickable || alvo);
      if (ok) {
        setStatus(`‚úÖ Respondido Q${qnum}.`, '#27ae60');
        setTimeout(tryNext, 900);
      } else {
        setStatus(`‚ùå Falha ao clicar Q${qnum}. Tentando clicar direto no texto...`, '#c0392b');
        clicarElemento(alvo);
        setTimeout(tryNext, 900);
      }
    } catch (err) {
      console.error('autoResponder erro:', err);
      setStatus('‚ùå Erro interno (veja console).', '#c0392b');
    }
  }

  function tryNext() {
    try {
      const nextBtn = Array.from(document.querySelectorAll('button,a,div')).find(b => {
        if (!b.textContent) return false;
        return /pr[o√≥]xima?|avan[c√ß]ar|continuar|seguinte|prosseguir|salvar|pr√≥ximo/i.test(b.textContent.trim());
      });
      if (nextBtn) {
        nextBtn.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=>{ try { nextBtn.click(); } catch(e){} }, 250);
      }
    } catch (e) {}
  }

  // debounce wrapper pro observer
  function scheduleAttempt() {
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => attemptAnswer(), 250);
  }

  function startAutomation() {
    if (observing) return;
    observing = true;
    startBtn.style.display = 'none';
    stopBtn.style.display = 'block';
    setStatus('‚ñ∂Ô∏è Automa√ß√£o iniciada.', '#27ae60');
    // roda imediatamente
    scheduleAttempt();
    // observer
    observer = new MutationObserver(scheduleAttempt);
    observer.observe(document.body, {childList:true, subtree:true, attributes:true, characterData:true});
    // backup interval
    checkInterval = setInterval(scheduleAttempt, 2000);
    container._observer = observer;
    container._interval = checkInterval;
  }

  function stopAutomation() {
    observing = false;
    startBtn.style.display = '';
    stopBtn.style.display = 'none';
    setStatus('‚èπÔ∏è Automa√ß√£o parada.');
    if (observer) { observer.disconnect(); observer = null; }
    if (checkInterval) { clearInterval(checkInterval); checkInterval = null; }
  }

  startBtn.addEventListener('click', startAutomation);
  stopBtn.addEventListener('click', stopAutomation);

  // limpinho: evita duplicar painel se j√° existe
  if (document.querySelectorAll('#autoResponderContainer_v1').length > 1) {
    setStatus('Painel duplicado detectado ‚Äî removendo o novo.');
    container.remove();
    return;
  }

  setTimeout(()=> setStatus("‚úÖ Sistema pronto. Aperte 'Iniciar Automa√ß√£o'."), 80);

})();
